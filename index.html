<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f16" />
  <title>ROTA ‚Ä¢ Bate Ponto Online</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + Dayjs -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>

  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b0f16;
      --card:#111827;
      --card2:#0f172a;
      --stroke:rgba(148,163,184,.18);
      --gold:#f59e0b;
      --gold2:#fbbf24;
      --red:#ef4444;
      --green:#10b981;
      --text:#e5e7eb;
    }
    html,body{
      min-height:100%;
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(245,158,11,.10), transparent 55%),
        radial-gradient(1100px 800px at 85% 20%, rgba(239,68,68,.07), transparent 58%),
        radial-gradient(900px 700px at 70% 95%, rgba(16,185,129,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
    }

    /* ‚úÖ FIX da ‚Äúlinha cortando‚Äù: sem mask-image */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.22;
      background-image:
        linear-gradient(rgba(148,163,184,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(148,163,184,.10) 1px, transparent 1px);
      background-size: 72px 72px;
      z-index:0;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: radial-gradient(closest-side at 50% 35%, transparent 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.55) 100%);
      z-index:0;
    }

    #appRoot{ position:relative; z-index:1; }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.15)), var(--card);
      border:1px solid rgba(245,158,11,.14);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .soft{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10)), var(--card2);
      border:1px solid var(--stroke);
    }
    .chip{ background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.28); }
    .mono{ font-variant-numeric: tabular-nums; }
    .focus-ring:focus{ outline:none; box-shadow: 0 0 0 3px rgba(245,158,11,.25); border-color: rgba(245,158,11,.45); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.55rem;
      font-weight:700; border-radius: .95rem; padding:.7rem 1.05rem;
      transition: transform .06s ease, box-shadow .25s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
      border:1px solid transparent;
      user-select:none;
      will-change: transform;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn-gold{ background: var(--gold); color:#081018; border-color: rgba(180,83,9,.85); }
    .btn-gold:hover{ background: var(--gold2); }
    .btn-red{ background: var(--red); color:#fff; border-color: rgba(185,28,28,.9); }
    .btn-red:hover{ background: #f87171; }
    .btn-green{ background: var(--green); color:#031c14; border-color: rgba(6,95,70,.9); }
    .btn-green:hover{ background: #34d399; }
    .btn-ghost{ background: rgba(148,163,184,.06); color: var(--text); border-color: rgba(148,163,184,.22); }
    .btn-ghost:hover{ background: rgba(148,163,184,.10); }
    .btn-outline{ background: transparent; color: var(--text); border-color: rgba(148,163,184,.30); }
    .btn-outline:hover{ background: rgba(148,163,184,.08); }

    .badge{
      font-size:.75rem; padding:.28rem .55rem; border-radius:.7rem;
      border:1px solid transparent; display:inline-flex; gap:.35rem; align-items:center;
      white-space:nowrap;
    }
    .badge-ok{ background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35); color:#a7f3d0; }
    .badge-leve{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#fde68a; }
    .badge-alta{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#fecaca; }

    .table thead tr{ background: rgba(245,158,11,.06); }
    .table th, .table td{ border-bottom: 1px dashed rgba(148,163,184,.22); }
    .table-tight th, .table-tight td{ padding-top:.65rem; padding-bottom:.65rem; }
  </style>

  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['ui-sans-serif', 'system-ui', 'Segoe UI', 'Inter', 'Roboto', 'Arial'] } } }
    }
  </script>
</head>

<body>
  <div id="appRoot" class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-8">

    <!-- Top bar -->
    <header class="glass rounded-3xl p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="relative">
          <div class="h-11 w-11 rounded-2xl grid place-items-center card text-xl font-black">R</div>
          <span class="absolute -right-1 -bottom-1 h-4 w-4 rounded-full bg-amber-500 ring-2 ring-black/50"></span>
        </div>

        <div class="min-w-[240px]">
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-wide">ROTA ‚Ä¢ Bate Ponto Online</h1>
          <p class="text-sm text-slate-300/80">Controle de patrulhamento ‚Ä¢ GTA RP</p>
        </div>

        <div class="ml-auto flex items-center gap-2 flex-wrap">
          <span class="badge chip"><span class="opacity-80">Meta:</span> <b class="ml-1">10h/semana</b></span>
          <span class="badge chip"><span class="opacity-80">Fuso:</span> <b class="ml-1">America/Sao_Paulo</b></span>
          <span class="badge btn-outline mono" id="clockBadge" title="Hora local">--:--</span>
          <button id="btnLogout" class="btn btn-outline hidden" type="button" title="Sair">
            <span aria-hidden="true">üö™</span><span class="hidden sm:inline">Sair</span>
          </button>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-3 flex-wrap">
        <div class="badge btn-outline">
          <span aria-hidden="true">üõ°Ô∏è</span>
          <span class="text-slate-300/90">Sistema protegido (login + RLS + anti-spam)</span>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="themeHint" class="btn btn-outline" type="button" title="Atalhos">
            <span aria-hidden="true">‚å®Ô∏è</span><span class="hidden sm:inline">Atalhos</span>
          </button>
        </div>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="loginAuth" class="card rounded-3xl p-5 sm:p-6 mb-6 max-w-xl mx-auto">
      <div class="flex items-start justify-between gap-4 flex-wrap mb-4">
        <div>
          <h2 class="text-lg sm:text-xl font-semibold">Login</h2>
          <p class="text-sm text-slate-300/75 mt-1">Entre com seu email e senha para bater ponto.</p>
        </div>
        <div class="badge chip">
          <span aria-hidden="true">üîí</span>
          <span class="text-slate-200/90">Acesso individual</span>
        </div>
      </div>

      <div class="grid gap-3">
        <div>
          <label class="block text-sm text-slate-300/80 mb-1">Email</label>
          <input id="emailInput" type="email" autocomplete="email"
            class="focus-ring w-full px-4 py-2.5 rounded-2xl border border-slate-600/40 bg-slate-950/30"
            placeholder="seuemail@gmail.com" />
        </div>

        <div>
          <label class="block text-sm text-slate-300/80 mb-1">Senha</label>
          <input id="passwordInput" type="password" autocomplete="current-password"
            class="focus-ring w-full px-4 py-2.5 rounded-2xl border border-slate-600/40 bg-slate-950/30"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <button id="loginBtn" class="btn btn-gold mt-1" type="button">
          <span aria-hidden="true">‚û°Ô∏è</span> Entrar
        </button>

        <p id="loginError" class="hidden text-sm text-red-300"></p>
        <p class="text-xs text-slate-300/70">
          Se der erro ‚Äúusu√°rio n√£o vinculado‚Äù, fale com o respons√°vel para ligar seu usu√°rio ao seu registro.
        </p>
      </div>
    </section>

    <!-- Main grid -->
    <div id="contentGrid" class="grid gap-6 items-start lg:grid-cols-5">
      <!-- Left -->
      <section id="mainSection" class="hidden lg:col-span-2 space-y-6">
        <div class="card rounded-3xl p-5 sm:p-6">
          <div class="flex items-start justify-between gap-4 mb-3">
            <div>
              <h2 class="text-xl font-semibold">Status de patrulha</h2>
              <p id="whoText" class="text-slate-300/80 text-sm mt-1">‚Äî</p>
            </div>
            <span id="liveBadge" class="badge btn-outline">OFFLINE</span>
          </div>

          <p id="statusText" class="text-slate-200/90">Fora de patrulha</p>

          <div class="mt-3 soft rounded-3xl p-4">
            <p class="text-xs text-slate-300/70">Tempo em patrulha</p>
            <p id="runningTimer" class="text-4xl font-extrabold mt-1 mono text-amber-400">00:00:00</p>
          </div>

          <div class="mt-4 grid gap-3">
            <div>
              <label class="block text-sm text-slate-300/80 mb-1">Patente (para registrar o turno)</label>
              <select id="rankSelect" class="focus-ring w-full px-4 py-2.5 rounded-2xl border border-slate-600/40 bg-slate-950/30"></select>
            </div>

            <div class="flex gap-3 flex-wrap">
              <button id="btnStart" class="btn btn-green" type="button">
                <span aria-hidden="true">‚ñ∂Ô∏è</span> Iniciar patrulha
              </button>
              <button id="btnStop" class="btn btn-red hidden" type="button">
                <span aria-hidden="true">‚èπÔ∏è</span> Encerrar
              </button>
              <button id="btnRefresh" class="btn btn-ghost" type="button" title="Atualizar estado">
                <span aria-hidden="true">‚Üª</span> Atualizar
              </button>
            </div>
          </div>

          <p class="text-xs text-slate-300/70 mt-3">
            Dica: se voc√™ fechou o navegador durante uma patrulha, use <b>Atualizar</b> ao entrar para recuperar o status.
          </p>
        </div>

        <div class="card rounded-3xl p-5 sm:p-6">
          <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
            <h3 class="text-lg font-semibold">Meus patrulhamentos</h3>
            <span class="badge chip"><span aria-hidden="true">üóÇÔ∏è</span> Hist√≥rico</span>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm table table-tight">
              <thead>
                <tr class="text-left text-slate-300/90">
                  <th class="py-2 pr-3">In√≠cio</th>
                  <th class="py-2 pr-3">T√©rmino</th>
                  <th class="py-2 pr-3">Dura√ß√£o</th>
                </tr>
              </thead>
              <tbody id="shiftTable"></tbody>
            </table>
          </div>

          <div id="myEmptyState" class="hidden mt-4 text-sm text-slate-300/75">
            Nenhum patrulhamento encontrado ainda.
          </div>
        </div>
      </section>

      <!-- Right -->
      <section id="statsSection" class="hidden lg:col-span-3 card rounded-3xl p-5 sm:p-6 lg:sticky lg:top-4">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <div>
            <h3 class="text-xl font-semibold">Estat√≠sticas da semana</h3>
            <p class="text-sm text-slate-300/75 mt-1">Ranking por tempo acumulado.</p>
          </div>

          <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-200/90">
            <span class="badge badge-ok">OK</span>
            <span class="badge badge-leve">Imin√™ncia leve</span>
            <span class="badge badge-alta">Imin√™ncia alta</span>
          </div>
        </div>

        <div class="flex items-center gap-3 mb-4 flex-wrap">
          <button id="btnPrevWeek" class="btn btn-ghost" type="button">‚óÄ Semana anterior</button>
          <div id="weekLabel" class="font-semibold text-amber-400"></div>
          <button id="btnNextWeek" class="btn btn-ghost" type="button">Semana seguinte ‚ñ∂</button>
          <button id="btnThisWeek" class="ml-auto btn btn-outline" type="button">Esta semana</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-base table table-tight">
            <thead>
              <tr class="text-left text-slate-300/90">
                <th class="py-2 pr-3">#</th>
                <th class="py-2 pr-3">Policial</th>
                <th class="py-2 pr-3">Patente</th>
                <th class="py-2 pr-3">Total</th>
                <th class="py-2 pr-3">Status</th>
              </tr>
            </thead>
            <tbody id="rankTable"></tbody>
          </table>
        </div>

        <div id="rankEmptyState" class="hidden mt-4 text-sm text-slate-300/75">
          Sem dados nesta semana.
        </div>
      </section>
    </div>

    <!-- Mobile hint -->
    <div class="lg:hidden glass rounded-3xl p-5 mt-6">
      <p class="text-sm text-slate-200/90">
        No celular, o painel completo aparece ap√≥s <b>Entrar</b> (layout √© melhor em telas maiores).
      </p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 w-[min(680px,calc(100%-2rem))] pointer-events-none"></div>

  <script>
  // === CONFIG ===
  const SUPABASE_URL = "https://ilonwkgtdszmpcjwlezc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0";
  const TZ = 'America/Sao_Paulo';

  // metas (minutos)
  const META_MIN = 10*60;
  const LEVE_MIN = 7*60;

  let supabaseClient;
  let activeShift = null;
  let timerInterval = null;

  let currentUser = null;
  let currentOfficer = null;
  let currentRank = null;

  let weekOffset = 0;

  // === UI helpers ===
  function toast(message, type='info'){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    const cls = type==='ok' ? 'badge-ok' : type==='warn' ? 'badge-leve' : type==='err' ? 'badge-alta' : 'btn-outline';
    el.className = `pointer-events-none glass rounded-2xl p-4 mb-2 border border-slate-500/25`;
    el.innerHTML = `<div class="flex items-start gap-3">
        <div class="mt-0.5 ${cls} badge">${type==='ok'?'‚úÖ':type==='warn'?'‚ö†Ô∏è':type==='err'?'‚õî':'‚ÑπÔ∏è'}</div>
        <div class="text-sm text-slate-100/95">${escapeHtml(message)}</div>
      </div>`;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; el.style.transition='opacity .25s ease, transform .25s ease'; }, 2400);
    setTimeout(()=> el.remove(), 2800);
  }

  function setBusy(btn, busy=true){
    if(!btn) return;
    btn.disabled = !!busy;
    btn.dataset._label ??= btn.innerHTML;
    if(busy){
      btn.innerHTML = `<span class="inline-block h-4 w-4 rounded-full border border-slate-200/40 border-t-transparent animate-spin"></span> Aguarde‚Ä¶`;
    } else {
      btn.innerHTML = btn.dataset._label;
    }
  }

  function escapeHtml(s){
    return s?.replace?.(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) ?? s;
  }
  function fmtDate(iso){ return dayjs(iso).tz(TZ).format('DD/MM/YYYY HH:mm'); }
  function hhmmss(totalSeconds){
    const t = Math.max(0, Math.floor(totalSeconds));
    const h = String(Math.floor(t/3600)).padStart(2,'0');
    const m = String(Math.floor((t%3600)/60)).padStart(2,'0');
    const s = String(t%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }
  function fmtDurSecs(totalSeconds){
    const secs = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    return `${h}h${m}m${s}s`;
  }

  function updateClock(){
    const el = document.getElementById('clockBadge');
    if(!el) return;
    el.textContent = dayjs().tz(TZ).format('HH:mm:ss');
  }

  document.addEventListener('DOMContentLoaded', async () => {
    dayjs.extend(window.dayjs_plugin_utc);
    dayjs.extend(window.dayjs_plugin_timezone);
    dayjs.extend(window.dayjs_plugin_duration);
    dayjs.tz.setDefault(TZ);

    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI events
    document.getElementById('loginBtn').addEventListener('click', loginWithEmail);
    document.getElementById('btnLogout').addEventListener('click', doLogout);

    document.getElementById('btnStart').addEventListener('click', startShift);
    document.getElementById('btnStop').addEventListener('click', endShift);
    document.getElementById('btnRefresh').addEventListener('click', () => refreshState(true));
    document.getElementById('themeHint').addEventListener('click', () => {
      toast('Atalhos: Enter = Login ‚Ä¢ S = Iniciar ‚Ä¢ E = Encerrar ‚Ä¢ R = Atualizar', 'info');
    });

    // keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      const loginVisible = !document.getElementById('loginAuth').classList.contains('hidden');
      if (k === 'enter' && loginVisible) loginWithEmail();
      if (k === 's' && !document.getElementById('btnStart').classList.contains('hidden')) startShift();
      if (k === 'e' && !document.getElementById('btnStop').classList.contains('hidden')) endShift();
      if (k === 'r') refreshState(true);
    });

    setInterval(updateClock, 1000);
    updateClock();

    // sess√£o autom√°tica
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session?.user) {
      currentUser = session.user;
      await initAppAfterLogin();
    }
  });

  async function loginWithEmail(){
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;

    const errEl = document.getElementById('loginError');
    errEl.classList.add('hidden');
    errEl.textContent = '';

    if (!email || !password) {
      errEl.textContent = 'Preencha email e senha.';
      errEl.classList.remove('hidden');
      return;
    }

    const btn = document.getElementById('loginBtn');
    setBusy(btn, true);

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

    setBusy(btn, false);

    if (error) {
      errEl.textContent = error.message;
      errEl.classList.remove('hidden');
      return;
    }

    currentUser = data?.user || null;
    toast('Login realizado.', 'ok');
    await initAppAfterLogin();
  }

  async function doLogout(){
    await supabaseClient.auth.signOut();
    toast('Voc√™ saiu.', 'info');
    location.reload();
  }

  async function initAppAfterLogin(){
    const { data: officer, error: offErr } = await supabaseClient
      .from('officers')
      .select('id,name,current_rank_id,active')
      .eq('user_id', currentUser.id)
      .single();

    if (offErr || !officer) {
      document.getElementById('loginError').textContent =
        'Seu usu√°rio n√£o est√° vinculado a um policial (officers.user_id). Fale com o respons√°vel.';
      document.getElementById('loginError').classList.remove('hidden');
      toast('Usu√°rio sem v√≠nculo de officer.', 'err');
      return;
    }
    if (officer.active === false) {
      toast('Seu registro est√° inativo.', 'err');
      return;
    }

    currentOfficer = officer;

    await loadRanks();
    await setDefaultRank();

    document.getElementById('loginAuth').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('btnLogout').classList.remove('hidden');

    updateWhoText();
    await refreshState(true);
    initStats();
  }

  function updateWhoText(){
    const rName = currentRank?.name ? ` ‚Ä¢ ${currentRank.name}` : '';
    document.getElementById('whoText').textContent = `${currentOfficer.name}${rName}`;
  }

  async function loadRanks(){
    const { data: ranks, error } = await supabaseClient
      .from('ranks').select('id,name,sort_order')
      .order('sort_order', { ascending: true });

    if (error) {
      toast('Erro ao carregar patentes: ' + error.message, 'err');
      return;
    }

    const rSel = document.getElementById('rankSelect');
    rSel.innerHTML = (ranks||[]).map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
    rSel.onchange = async () => {
      const { data: rk } = await supabaseClient.from('ranks').select('id,name').eq('id', rSel.value).single();
      currentRank = rk || currentRank;
      updateWhoText();
    };
  }

  async function setDefaultRank(){
    const rSel = document.getElementById('rankSelect');

    const { data: lastShift } = await supabaseClient
      .from('shifts').select('rank_id')
      .eq('user_id', currentUser.id)
      .not('rank_id', 'is', null)
      .order('started_at', { ascending: false }).limit(1);

    if (lastShift && lastShift.length && lastShift[0].rank_id) {
      rSel.value = String(lastShift[0].rank_id);
    } else if (currentOfficer.current_rank_id) {
      rSel.value = String(currentOfficer.current_rank_id);
    } else if (rSel.options.length) {
      rSel.selectedIndex = 0;
    }

    const { data: rk } = await supabaseClient.from('ranks').select('id,name').eq('id', rSel.value).single();
    currentRank = rk || currentRank;
    updateWhoText();
  }

  // ‚úÖ TIMER instant√¢neo (sem esperar Supabase)
  function runTimer(){
    stopTimer();

    const tick = () => {
      if (!activeShift?.started_at) return;
      const diffSeconds = Math.floor(
        (Date.now() - new Date(activeShift.started_at).getTime()) / 1000
      );
      document.getElementById('runningTimer').textContent = hhmmss(diffSeconds);
    };

    tick(); // üî• na hora
    timerInterval = setInterval(tick, 1000);
  }

  function stopTimer(){
    if(timerInterval){
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  // ---------- Estado / Turno ----------
  async function refreshState(showToast=false){
    if(!currentUser) return;

    const { data, error } = await supabaseClient
      .from('shifts').select('*')
      .eq('user_id', currentUser.id)
      .is('ended_at', null)
      .order('started_at', { ascending: false })
      .limit(1);

    if (error) { toast(error.message, 'err'); return; }

    activeShift = data && data[0] ? data[0] : null;

    const liveBadge = document.getElementById('liveBadge');
    if (activeShift) {
      document.getElementById('statusText').textContent = 'Em patrulha desde ' + fmtDate(activeShift.started_at);
      document.getElementById('btnStart').classList.add('hidden');
      document.getElementById('btnStop').classList.remove('hidden');
      liveBadge.className = 'badge badge-ok';
      liveBadge.textContent = 'EM PATRULHA';
      runTimer();
    } else {
      document.getElementById('statusText').textContent = 'Fora de patrulha';
      document.getElementById('btnStart').classList.remove('hidden');
      document.getElementById('btnStop').classList.add('hidden');
      liveBadge.className = 'badge btn-outline';
      liveBadge.textContent = 'OFFLINE';
      stopTimer();
      document.getElementById('runningTimer').textContent = '00:00:00';
    }

    await loadMyShifts();
    if(showToast) toast('Atualizado.', 'info');
  }

  // ‚úÖ START com timer imediato + sincroniza com banco
  async function startShift(){
    if (!currentUser) return toast('Fa√ßa login.', 'warn');
    if (activeShift) return toast('Voc√™ j√° est√° em patrulha.', 'warn');

    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    setBusy(btnStart, true);

    // 1) come√ßa localmente na hora
    const localStartedAt = new Date().toISOString();
    activeShift = { started_at: localStartedAt, _pending: true };

    document.getElementById('statusText').textContent = 'Em patrulha desde ' + fmtDate(localStartedAt);
    document.getElementById('btnStart').classList.add('hidden');
    document.getElementById('btnStop').classList.remove('hidden');
    document.getElementById('liveBadge').className = 'badge badge-ok';
    document.getElementById('liveBadge').textContent = 'EM PATRULHA';

    // enquanto pendente, n√£o deixa encerrar ainda
    btnStop.disabled = true;

    runTimer();

    // 2) grava no banco
    const { data, error } = await supabaseClient
      .from('shifts')
      .insert([{ rank_id: currentRank?.id ?? null }])
      .select()
      .single();

    setBusy(btnStart, false);

    if (error) {
      toast('Erro ao iniciar patrulha: ' + error.message, 'err');
      activeShift = null;
      stopTimer();
      btnStop.disabled = false;
      await refreshState(false);
      return;
    }

    // 3) sincroniza com o registro real
    activeShift = data;
    btnStop.disabled = false;

    toast('Patrulha iniciada.', 'ok');

    // atualiza listas sem travar timer
    loadMyShifts();
    loadWeeklyStats_v2();
  }

  async function endShift(){
    if (!currentUser) return toast('Fa√ßa login.', 'warn');
    if (!activeShift) return toast('Nenhuma patrulha em andamento.', 'warn');

    if (activeShift._pending || !activeShift.id) {
      return toast('Aguarde confirmar o in√≠cio para encerrar.', 'warn');
    }

    const btn = document.getElementById('btnStop');
    setBusy(btn, true);

    const { error } = await supabaseClient
      .from('shifts')
      .update({ ended_at: new Date().toISOString() })
      .eq('id', activeShift.id);

    setBusy(btn, false);

    if (error) return toast('Erro: ' + error.message, 'err');

    toast('Patrulha encerrada.', 'ok');
    activeShift = null;
    await refreshState(false);
    loadWeeklyStats_v2();
  }

  async function loadMyShifts(){
    const { data, error } = await supabaseClient
      .from('shifts').select('id, started_at, ended_at')
      .eq('user_id', currentUser.id)
      .order('started_at', { ascending: false });

    if (error) { toast(error.message, 'err'); return; }

    const tbody = document.getElementById('shiftTable');
    const empty = document.getElementById('myEmptyState');
    tbody.innerHTML = '';

    if (!data || !data.length){
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    data.forEach(s=>{
      const durationSecs = s.ended_at
        ? Math.max(0, Math.floor(dayjs(s.ended_at).diff(dayjs(s.started_at), 'second')))
        : 0;

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class='py-2 pr-3 text-slate-200/95'>${fmtDate(s.started_at)}</td>
        <td class='py-2 pr-3 text-slate-200/95'>${s.ended_at?fmtDate(s.ended_at):'<span class="text-red-300">em andamento‚Ä¶</span>'}</td>
        <td class='py-2 pr-3 mono text-amber-300'>${s.ended_at?fmtDurSecs(durationSecs):'‚Äî'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ---------- Estat√≠sticas semanais ----------
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'btnPrevWeek') changeWeek(-1);
    if (e.target && e.target.id === 'btnNextWeek') changeWeek(1);
    if (e.target && e.target.id === 'btnThisWeek') setWeek(0);
  });

  function initStats(){ updateWeekLabel(); loadWeeklyStats_v2(); }
  function changeWeek(delta){ weekOffset += delta; updateWeekLabel(); loadWeeklyStats_v2(); }
  function setWeek(n){ weekOffset = n; updateWeekLabel(); loadWeeklyStats_v2(); }

  function getWeekRange(offset){
    offset = offset||0;
    const today = dayjs().tz(TZ).add(offset, 'week');
    const dow = (today.day()+6)%7; // segunda-feira
    const start = today.startOf('day').subtract(dow, 'day');
    const end = start.add(7,'day');
    return { start, end };
  }
  function updateWeekLabel(){
    const el = document.getElementById('weekLabel');
    if (!el) return;
    const { start, end } = getWeekRange(weekOffset);
    el.textContent = `${start.format('DD/MM')} ‚Äî ${end.subtract(1,'day').format('DD/MM/YYYY')}`;
  }

  async function loadWeeklyStats_v2(){
    const { start, end } = getWeekRange(weekOffset);
    const startIso = start.toISOString();
    const endIso = end.toISOString();

    const { data: officers } = await supabaseClient
      .from('officers').select('id,name,current_rank_id').order('name', { ascending: true });

    const { data: ranks } = await supabaseClient
      .from('ranks').select('id,name,sort_order').order('sort_order', { ascending: true });

    const rankMap = Object.fromEntries((ranks||[]).map(r=>[String(r.id), r.name]));

    const { data: sA } = await supabaseClient
      .from('shifts').select('officer_id, rank_id, started_at, ended_at')
      .gte('started_at', startIso).lt('started_at', endIso);

    const { data: sB } = await supabaseClient
      .from('shifts').select('officer_id, rank_id, started_at, ended_at')
      .lt('started_at', startIso).or(`ended_at.is.null,ended_at.gte.${startIso}`);

    const allShifts = [...(sA||[]), ...(sB||[])];

    const grouped = new Map();
    for (const s of allShifts) {
      if (!s.officer_id) continue;
      const arr = grouped.get(s.officer_id) || [];
      arr.push(s);
      grouped.set(s.officer_id, arr);
    }

    const totalsSecs = new Map();
    const lastRankInWeek = new Map();

    for (const [officerId, list] of grouped.entries()) {
      list.sort((a,b)=> dayjs(a.started_at).valueOf() - dayjs(b.started_at).valueOf());
      let total = 0;
      let lastRank = null;
      let lastStart = null;

      for (const s of list) {
        const sStart = dayjs(s.started_at);
        const sEnd = s.ended_at ? dayjs(s.ended_at) : dayjs();
        const clampStart = sStart.isAfter(start) ? sStart : start;
        const clampEnd = sEnd.isBefore(end) ? sEnd : end;
        const secs = Math.max(0, Math.floor(clampEnd.diff(clampStart, 'second')));
        if (secs > 0) {
          total += secs;
          if (!lastStart || sStart.isAfter(lastStart)) {
            lastStart = sStart;
            lastRank = s.rank_id ?? lastRank;
          }
        }
      }
      totalsSecs.set(officerId, total);
      if (lastRank) lastRankInWeek.set(officerId, lastRank);
    }

    const needFallback = (officers||[]).filter(o => !lastRankInWeek.has(o.id));
    if (needFallback.length) {
      const ids = needFallback.map(o=>o.id);
      const { data: lastBefore } = await supabaseClient
        .from('shifts').select('officer_id, rank_id, started_at')
        .in('officer_id', ids).lt('started_at', endIso)
        .not('rank_id', 'is', null).order('started_at', { ascending: false });

      const seen = new Set();
      if (lastBefore) {
        for (const row of lastBefore) {
          if (seen.has(row.officer_id)) continue;
          seen.add(row.officer_id);
          lastRankInWeek.set(row.officer_id, row.rank_id);
        }
      }
    }

    const rows = (officers||[]).map(o=>{
      const secs = totalsSecs.get(o.id) || 0;
      const rankIdToShow = lastRankInWeek.get(o.id) ?? o.current_rank_id ?? null;
      const rankName = rankIdToShow ? (rankMap[String(rankIdToShow)] || '-') : '-';

      let status = 'Frequ√™ncia OK'; let badgeClass='badge badge-ok';
      if (secs < LEVE_MIN*60){ status='Imin√™ncia Alta'; badgeClass='badge badge-alta'; }
      else if (secs < META_MIN*60){ status='Imin√™ncia Leve'; badgeClass='badge badge-leve'; }

      return { officer:o.name, rank: rankName, secs, status, badgeClass };
    }).sort((a,b)=> b.secs - a.secs);

    const tbody = document.getElementById('rankTable');
    const empty = document.getElementById('rankEmptyState');
    tbody.innerHTML='';

    if (!rows.length){
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    rows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class='py-2 pr-3 text-slate-300/80 mono'>${String(i+1).padStart(2,'0')}</td>
        <td class='py-2 pr-3 text-slate-100/95'>${escapeHtml(r.officer)}</td>
        <td class='py-2 pr-3 whitespace-nowrap text-slate-200/95'>${escapeHtml(r.rank)}</td>
        <td class='py-2 pr-3 mono text-amber-300'>${fmtDurSecs(r.secs)}</td>
        <td class='py-2 pr-3'><span class='${r.badgeClass}'>${r.status}</span></td>`;
      tbody.appendChild(tr);
    });
  }
  </script>
</body>
</html>

