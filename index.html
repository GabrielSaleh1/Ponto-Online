<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f16" />
  <title>ROTA • Bate Ponto Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>
  <style>
    /* Paleta e toques de tema ROTA: preto/ardósia, dourado/âmbar, vermelho */
    :root{
      --rota-bg: #0b0f16;
      --rota-card: #121826;
      --rota-soft: #1a2235;
      --rota-gold: #f59e0b; /* amber-500 */
      --rota-gold-700: #b45309;
      --rota-red: #ef4444;  /* red-500 */
      --rota-green: #10b981;/* emerald-500 */
      --rota-text: #e5e7eb; /* slate-200 */
      --rota-sub: #94a3b8;  /* slate-400 */
    }
    html, body { background: var(--rota-bg); color: var(--rota-text); }
    .rota-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)), var(--rota-card); border: 1px solid rgba(245,158,11,0.12); }
    .rota-soft { background: var(--rota-soft); }
    .rota-title { letter-spacing: .04em; }
    .rota-divider { border-color: rgba(245,158,11,0.2); }
    .rota-accent { color: var(--rota-gold); }
    .rota-chip  { background: rgba(245,158,11,0.12); color: var(--rota-text); border: 1px solid rgba(245,158,11,0.25); }
    .rota-table thead tr { background: rgba(245,158,11,0.06); }
    .rota-table th, .rota-table td { border-bottom: 1px dashed rgba(148,163,184,0.2); }
    .btn {
      display:inline-flex;align-items:center;gap:.5rem;
      font-weight:600; border-radius: .75rem; padding:.6rem 1rem;
      transition: transform .06s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease;
      border:1px solid transparent;
    }
    .btn:active { transform: translateY(1px); }
    .btn-gold { background: var(--rota-gold); color: #0b0f16; border-color: var(--rota-gold-700); }
    .btn-gold:hover { background:#fbbf24; }
    .btn-red  { background: var(--rota-red); color: #fff; border-color:#b91c1c; }
    .btn-red:hover{ background:#f87171; }
    .btn-green{ background: var(--rota-green); color:#042016; border-color:#065f46; }
    .btn-green:hover{ background:#34d399; }
    .btn-ghost{ background: transparent; color: var(--rota-text); border-color: rgba(148,163,184,.25); }
    .btn-ghost:hover{ background: rgba(148,163,184,.08); }

    /* Faixa “tactical” diagonal no topo */
    .tactical-band {
      position: relative; overflow: hidden;
      background: linear-gradient(120deg, rgba(245,158,11,.16) 0%, rgba(245,158,11,.0) 60%), var(--rota-soft);
      border:1px solid rgba(245,158,11,0.2);
    }
    .tactical-band::after{
      content:""; position:absolute; inset:-40% -30%;
      background:
        repeating-linear-gradient(135deg,
          rgba(239, 68, 68, .22) 0 10px,
          rgba(239, 68, 68, 0) 10px 22px);
      transform: rotate(-2deg);
      pointer-events:none; mix-blend-mode: overlay;
    }
    .badge {
      font-size:.75rem; padding:.25rem .5rem; border-radius:.5rem; border:1px solid transparent; display:inline-block;
    }
    .badge-ok    { background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35); color:#a7f3d0; }
    .badge-leve  { background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#fde68a; }
    .badge-alta  { background:rgba(239,68,68,.12);  border-color:rgba(239,68,68,.35);  color:#fecaca; }
    .mono { font-variant-numeric: tabular-nums; }
    .table-tight th, .table-tight td { padding-top:.6rem; padding-bottom:.6rem; }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header ROTA -->
    <header class="tactical-band rounded-2xl p-5 mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="h-10 w-10 rounded-xl flex items-center justify-center rota-card ring-1 ring-amber-500/30 text-xl font-black">R</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold rota-title tracking-wide">ROTA • Bate Ponto Online</h1>
          <p class="text-sm text-slate-400">Rondas Ostensivas Tobias de Aguiar — Controle de patrulhamento</p>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="badge rota-chip">Meta semanal: <b class="ml-1">10h</b></span>
          <span class="badge rota-chip">Fuso: <b class="ml-1">America/Sao_Paulo</b></span>
        </div>
      </div>
    </header>

    <!-- Identificação -->
    <section id="loginSection" class="mb-6 rota-card rounded-2xl p-5">
      <h2 class="text-lg font-semibold mb-3">Identificação</h2>
      <div class="grid sm:grid-cols-3 gap-3 items-end">
        <div class="sm:col-span-2">
          <label class="block text-sm text-slate-400 mb-1">Policial</label>
          <select id="officerSelect" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"></select>
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-1">Patente</label>
          <select id="rankSelect" class="w-full px-4 py-2 rounded-xl border border-slate-600/40 bg-slate-900/40 focus:outline-none focus:ring-2 focus:ring-amber-500/40"></select>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="enterBtn" class="btn btn-gold">Entrar</button>
        <button id="reloadLists" class="btn btn-ghost">Recarregar lista</button>
      </div>
      <p id="loginMsg" class="text-sm text-slate-400 mt-2"></p>
    </section>

    <!-- Grid principal -->
    <div id="contentGrid" class="grid gap-6 items-start lg:grid-cols-5">
      <!-- Painel principal -->
      <section id="mainSection" class="hidden lg:col-span-2 space-y-6">
        <div class="rota-card rounded-2xl p-5">
          <h2 class="text-xl font-semibold mb-2">Status de patrulha</h2>
          <p id="whoText" class="text-slate-400 text-sm mb-1">—</p>
          <p id="statusText" class="text-slate-300">Fora de patrulha</p>
          <p id="runningTimer" class="text-4xl font-extrabold mt-2 mono rota-accent">00:00:00</p>
          <div class="mt-4 flex gap-3">
            <button id="btnStart" class="btn btn-green">Iniciar patrulha</button>
            <button id="btnStop"  class="btn btn-red hidden">Encerrar</button>
          </div>
        </div>

        <div class="rota-card rounded-2xl p-5">
          <h3 class="text-lg font-semibold mb-4">Patrulhamentos registrados</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm rota-table table-tight">
              <thead>
                <tr class="text-left text-slate-300">
                  <th class="py-2">Início</th>
                  <th class="py-2">Término</th>
                  <th class="py-2">Duração</th>
                </tr>
              </thead>
              <tbody id="shiftTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Estatísticas -->
      <section id="statsSection" class="hidden lg:col-span-3 rota-card rounded-2xl p-5 lg:sticky lg:top-4">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <h3 class="text-xl font-semibold">Estatísticas da semana</h3>
          <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-300">
            <span class="badge badge-ok">OK</span>
            <span class="badge badge-leve">Iminência leve</span>
            <span class="badge badge-alta">Iminência alta</span>
          </div>
        </div>
        <div class="flex items-center gap-3 mb-4 text-sm">
          <button id="btnPrevWeek" class="btn btn-ghost">◀ Semana anterior</button>
          <div id="weekLabel" class="font-medium rota-accent"></div>
          <button id="btnNextWeek" class="btn btn-ghost">Semana seguinte ▶</button>
          <button id="btnThisWeek" class="ml-auto btn btn-ghost">Esta semana</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-base rota-table table-tight">
            <thead>
              <tr class="text-left text-slate-300">
                <th class="py-2">#</th>
                <th class="py-2">Policial</th>
                <th class="py-2">Patente</th>
                <th class="py-2">Total</th>
                <th class="py-2">Status</th>
              </tr>
            </thead>
            <tbody id="rankTable"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
  const SUPABASE_URL = "https://ilonwkgtdszmpcjwlezc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0";
  const TZ = 'America/Sao_Paulo';
  const META_MIN = 10*60; // minutos
  const LEVE_MIN = 7*60;  // minutos

  let supabaseClient, activeShift=null, timerInterval=null;
  let currentOfficer=null;
  let currentRank=null;
  let weekOffset = 0;

  document.addEventListener('DOMContentLoaded', async () => {
    dayjs.extend(window.dayjs_plugin_utc);
    dayjs.extend(window.dayjs_plugin_timezone);
    dayjs.extend(window.dayjs_plugin_duration);
    dayjs.tz.setDefault(TZ);

    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById('enterBtn').addEventListener('click', enterApp);
    document.getElementById('reloadLists').addEventListener('click', loadLists);
    document.getElementById('btnStart').addEventListener('click', startShift);
    document.getElementById('btnStop').addEventListener('click', endShift);

    await loadLists();
  });

  // ---------- Helpers ----------
  function escapeHtml(s){return s?.replace?.(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) ?? s;}
  function fmtDate(iso){return dayjs(iso).tz(TZ).format('DD/MM/YYYY HH:mm');}
  function hhmmss(t){t=Math.max(0,Math.floor(t));const h=String(Math.floor(t/3600)).padStart(2,'0');const m=String(Math.floor((t%3600)/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return`${h}:${m}:${s}`;}
  // duração com segundos (ex.: 1h23m45s)
  function fmtDurSecs(totalSeconds){
    const secs = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    return `${h}h${m}m${s}s`;
  }

  // ---------- Listas ----------
  async function loadLists(){
    const loginMsg = document.getElementById('loginMsg');
    loginMsg.textContent = 'Carregando listas…';

    const { data: officers, error: offErr } = await supabaseClient
      .from('officers').select('id,name,current_rank_id,active').eq('active', true).order('name', { ascending: true });
    const { data: ranks } = await supabaseClient
      .from('ranks').select('id,name,sort_order').order('sort_order', { ascending: true });

    if (offErr) { loginMsg.textContent = 'Erro ao carregar policiais: ' + offErr.message; return; }

    const oSel = document.getElementById('officerSelect');
    const rSel = document.getElementById('rankSelect');

    oSel.innerHTML = (officers||[]).map(o=>`<option value="${o.id}" data-rank="${o.current_rank_id||''}">${escapeHtml(o.name)}</option>`).join('');
    rSel.innerHTML = (ranks||[]).map(r=>`<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');

    loginMsg.textContent = '';

    oSel.addEventListener('change', () => { setDefaultRankForOfficer(oSel.value); });
    if (oSel.value) { await setDefaultRankForOfficer(oSel.value); }
  }

  async function setDefaultRankForOfficer(officerId) {
    const rSel = document.getElementById('rankSelect');
    const { data: lastShift } = await supabaseClient
      .from('shifts').select('rank_id').eq('officer_id', officerId)
      .not('rank_id', 'is', null).order('started_at', { ascending: false }).limit(1);
    if (lastShift && lastShift.length && lastShift[0].rank_id) {
      rSel.value = String(lastShift[0].rank_id); return;
    }
    const oSel = document.getElementById('officerSelect');
    const opt = oSel.options[oSel.selectedIndex];
    const defRank = opt?.getAttribute('data-rank');
    if (defRank) { rSel.value = String(defRank); return; }
    if (rSel.options.length) rSel.selectedIndex = 0;
  }

  // ---------- Fluxo principal ----------
  async function enterApp(){
    const oSel = document.getElementById('officerSelect');
    const rSel = document.getElementById('rankSelect');
    if (!oSel.value) return alert('Selecione o policial.');
    if (!rSel.value) await setDefaultRankForOfficer(oSel.value);

    const { data: officer } = await supabaseClient.from('officers').select('id,name').eq('id', oSel.value).single();
    const { data: rank } = await supabaseClient.from('ranks').select('id,name').eq('id', rSel.value).single();
    currentOfficer = officer; currentRank = rank;

    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('statsSection').classList.remove('hidden');
    document.getElementById('whoText').textContent = `${officer.name} • ${rank.name}`;

    refreshState();
    initStats();
  }

  async function refreshState(){
    const { data } = await supabaseClient
      .from('shifts').select('*')
      .eq('officer_id', currentOfficer.id)
      .is('ended_at', null)
      .order('started_at', { ascending: false })
      .limit(1);

    activeShift = data && data[0] ? data[0] : null;

    if (activeShift) {
      document.getElementById('statusText').textContent = 'Em patrulha desde ' + fmtDate(activeShift.started_at);
      document.getElementById('btnStart').classList.add('hidden');
      document.getElementById('btnStop').classList.remove('hidden');
      runTimer();
    } else {
      document.getElementById('statusText').textContent = 'Fora de patrulha';
      document.getElementById('btnStart').classList.remove('hidden');
      document.getElementById('btnStop').classList.add('hidden');
      stopTimer();
      document.getElementById('runningTimer').textContent = '00:00:00';
    }
    loadMyShifts();
  }

  async function startShift(){
    if (activeShift) return;
    const rSel = document.getElementById('rankSelect');
    if (rSel.value && (!currentRank || String(currentRank.id) !== String(rSel.value))) {
      const { data: rk } = await supabaseClient.from('ranks').select('id,name').eq('id', rSel.value).single();
      currentRank = rk || currentRank;
    }
    const { data, error } = await supabaseClient
      .from('shifts')
      .insert([{ officer_id: currentOfficer.id, rank_id: currentRank.id, started_at: new Date().toISOString() }])
      .select().single();
    if (error) return alert('Erro: '+error.message);
    activeShift = data;
    refreshState();
  }

  async function endShift(){
    if (!activeShift) return;
    const { error } = await supabaseClient
      .from('shifts').update({ ended_at: new Date().toISOString() }).eq('id', activeShift.id);
    if (error) return alert('Erro: '+error.message);
    activeShift=null;
    refreshState();
  }

  async function loadMyShifts(){
    const { data } = await supabaseClient
      .from('shifts').select('id, started_at, ended_at')
      .eq('officer_id', currentOfficer.id)
      .order('started_at', { ascending: false });
    const tbody = document.getElementById('shiftTable');
    tbody.innerHTML='';
    (data||[]).forEach(s=>{
      const durationSecs = s.ended_at
        ? Math.max(0, Math.floor(dayjs(s.ended_at).diff(dayjs(s.started_at), 'second')))
        : 0;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class='py-2 pr-3'>${fmtDate(s.started_at)}</td>
                    <td class='py-2 pr-3'>${s.ended_at?fmtDate(s.ended_at):'<span class="text-red-400">em andamento…</span>'}</td>
                    <td class='py-2 pr-3 mono'>${s.ended_at?fmtDurSecs(durationSecs):'—'}</td>`;
      tbody.appendChild(tr);
    });
  }

  function runTimer(){
    stopTimer();
    timerInterval=setInterval(()=>{
      const diff=dayjs.duration(dayjs().diff(dayjs(activeShift.started_at)));
      document.getElementById('runningTimer').textContent=hhmmss(diff.asSeconds());
    },1000);
  }
  function stopTimer(){ if(timerInterval){clearInterval(timerInterval);timerInterval=null;} }

  // ---------- Estatísticas semanais ----------
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'btnPrevWeek') { changeWeek(-1); }
    if (e.target && e.target.id === 'btnNextWeek') { changeWeek(1); }
    if (e.target && e.target.id === 'btnThisWeek') { setWeek(0); }
  });

  function initStats(){ updateWeekLabel(); loadWeeklyStats_v2(); }
  function changeWeek(delta){ weekOffset += delta; updateWeekLabel(); loadWeeklyStats_v2(); }
  function setWeek(n){ weekOffset = n; updateWeekLabel(); loadWeeklyStats_v2(); }

  function getWeekRange(offset){
    offset = offset||0;
    const today = dayjs().tz(TZ).add(offset, 'week');
    const dow = (today.day()+6)%7; // segunda-feira como início
    const start = today.startOf('day').subtract(dow, 'day');
    const end = start.add(7,'day');
    return { start, end };
  }
  function updateWeekLabel(){
    const el = document.getElementById('weekLabel');
    if (!el) return;
    const { start, end } = getWeekRange(weekOffset);
    el.textContent = `${start.format('DD/MM')} — ${end.subtract(1,'day').format('DD/MM/YYYY')}`;
  }

  // Patente = última usada na semana; se não teve, última antes do fim da semana
  async function loadWeeklyStats_v2(){
    const { start, end } = getWeekRange(weekOffset);
    const startIso = start.toISOString();
    const endIso = end.toISOString();

    const { data: officers } = await supabaseClient
      .from('officers').select('id,name,current_rank_id').order('name', { ascending: true });
    const { data: ranks } = await supabaseClient
      .from('ranks').select('id,name,sort_order').order('sort_order', { ascending: true });
    const rankMap = Object.fromEntries((ranks||[]).map(r=>[String(r.id), r.name]));

    // shifts que tocam a semana
    const { data: sA } = await supabaseClient
      .from('shifts').select('officer_id, rank_id, started_at, ended_at')
      .gte('started_at', startIso).lt('started_at', endIso);
    const { data: sB } = await supabaseClient
      .from('shifts').select('officer_id, rank_id, started_at, ended_at')
      .lt('started_at', startIso).or(`ended_at.is.null,ended_at.gte.${startIso}`);
    const allShifts = [...(sA||[]), ...(sB||[])];

    // agrupa por policial
    const grouped = new Map();
    for (const s of allShifts) {
      if (!s.officer_id) continue;
      const arr = grouped.get(s.officer_id) || [];
      arr.push(s);
      grouped.set(s.officer_id, arr);
    }

    // totais (em segundos) e última patente usada
    const totalsSecs = new Map();   // officer_id -> total segundos na semana
    const lastRankInWeek = new Map();

    for (const [officerId, list] of grouped.entries()) {
      list.sort((a,b)=> dayjs(a.started_at).valueOf() - dayjs(b.started_at).valueOf());
      let total = 0;
      let lastRank = null;
      let lastStart = null;

      for (const s of list) {
        const sStart = dayjs(s.started_at);
        const sEnd = s.ended_at ? dayjs(s.ended_at) : dayjs();
        const clampStart = sStart.isAfter(start) ? sStart : start;
        const clampEnd = sEnd.isBefore(end) ? sEnd : end;
        const secs = Math.max(0, Math.floor(clampEnd.diff(clampStart, 'second')));
        if (secs > 0) {
          total += secs;
          if (!lastStart || sStart.isAfter(lastStart)) {
            lastStart = sStart;
            lastRank = s.rank_id ?? lastRank;
          }
        }
      }
      totalsSecs.set(officerId, total);
      if (lastRank) lastRankInWeek.set(officerId, lastRank);
    }

    // para quem não teve shift na semana: última patente antes do fim da semana
    const needFallback = (officers||[]).filter(o => !lastRankInWeek.has(o.id));
    if (needFallback.length) {
      const ids = needFallback.map(o=>o.id);
      const { data: lastBefore } = await supabaseClient
        .from('shifts').select('officer_id, rank_id, started_at')
        .in('officer_id', ids).lt('started_at', endIso)
        .not('rank_id', 'is', null).order('started_at', { ascending: false });
      const seen = new Set();
      if (lastBefore) {
        for (const row of lastBefore) {
          if (seen.has(row.officer_id)) continue;
          seen.add(row.officer_id);
          lastRankInWeek.set(row.officer_id, row.rank_id);
        }
      }
    }

    // se officers vier vazio por RLS, tenta ao menos os IDs que têm total
    let officersList = officers || [];
    if ((!officersList || officersList.length === 0) && totalsSecs.size) {
      const ids = [...totalsSecs.keys()];
      const { data: off2 } = await supabaseClient
        .from('officers').select('id,name,current_rank_id').in('id', ids);
      officersList = off2 || [];
    }

    const rows = (officersList||[]).map(o=>{
      const secs = totalsSecs.get(o.id) || 0;
      const rankIdToShow = lastRankInWeek.get(o.id) ?? o.current_rank_id ?? null;
      const rankName = rankIdToShow ? (rankMap[String(rankIdToShow)] || '-') : '-';

      let status = 'Frequência OK'; let badgeClass='badge badge-ok';
      if (secs < LEVE_MIN*60){ status='Iminência Alta'; badgeClass='badge badge-alta'; }
      else if (secs < META_MIN*60){ status='Iminência Leve'; badgeClass='badge badge-leve'; }

      return { officer:o.name, rank: rankName, secs, status, badgeClass };
    }).sort((a,b)=> b.secs - a.secs);

    const tbody = document.getElementById('rankTable');
    if (!tbody) return;
    tbody.innerHTML='';
    if (!rows.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class='py-2 pr-3' colspan='5'>Nenhum policial encontrado.</td>`;
      tbody.appendChild(tr);
      return;
    }
    rows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class='py-2 pr-3 text-slate-400 mono'>${String(i+1).padStart(2,'0')}</td>
        <td class='py-2 pr-3'>${escapeHtml(r.officer)}</td>
        <td class='py-2 pr-3 whitespace-nowrap'>${escapeHtml(r.rank)}</td>
        <td class='py-2 pr-3 mono rota-accent'>${fmtDurSecs(r.secs)}</td>
        <td class='py-2 pr-3'><span class='${r.badgeClass}'>${r.status}</span></td>`;
      tbody.appendChild(tr);
    });
  }
  </script>
</body>
</html>
